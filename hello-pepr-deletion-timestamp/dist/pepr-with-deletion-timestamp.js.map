{
  "version": 3,
  "sources": ["../pepr.ts", "../package.json", "../capabilities/deletion.ts"],
  "sourcesContent": ["import { PeprModule } from \"pepr\";\nimport cfg from \"./package.json\";\n\nimport { HelloPeprDeletion } from \"./capabilities/deletion\";\n\nnew PeprModule(cfg, [HelloPeprDeletion]);\n", "{\n  \"name\": \"hello-pepr-deletion-timestamp\",\n  \"version\": \"0.0.1\",\n  \"description\": \"Pepr feature: WithDeletionTimestamp\",\n  \"keywords\": [\n    \"pepr\",\n    \"k8s\",\n    \"policy-engine\",\n    \"pepr-module\",\n    \"security\"\n  ],\n  \"engines\": {\n    \"node\": \">=18.0.0\"\n  },\n  \"pepr\": {\n    \"uuid\": \"with-deletion-timestamp\",\n    \"onError\": \"reject\",\n    \"webhookTimeout\": 10,\n    \"customLabels\": {\n      \"namespace\": {\n        \"pepr.dev\": \"\"\n      }\n    },\n    \"alwaysIgnore\": {\n      \"namespaces\": []\n    },\n    \"includedFiles\": []\n  },\n  \"dependencies\": {\n    \"pepr\": \"^0.34.1\"\n  },\n  \"devDependencies\": {\n    \"@jest/globals\": \"^29.7.0\",\n    \"@types/node\": \"^20.13.0\",\n    \"jest\": \"^29.7.0\",\n    \"kubernetes-fluent-client\": \"^2.6.1\",\n    \"typescript\": \"5.3.3\"\n  },\n  \"scripts\": {\n    \"pepr\": \"pepr\",\n    \"cli\": \"npm run --workspace helpers cli -- --module=$(pwd)\",\n    \"test\": \"npm run cli -- test --suite all\",\n    \"test:e2e\": \"npm run cli -- test --suite e2e\",\n    \"test:unit\": \"npm run cli -- test --suite unit\"\n  }\n}\n", "import { Capability, K8s, Log, a } from \"pepr\";\nimport { GenericKind } from \"kubernetes-fluent-client\";\nimport { Operation } from \"fast-json-patch\";\n/**\n * Test two different filters for deletion timestamp.\n * Validate that shouldSkipRequest works for admission requests.\n * Validate that filterNoMatchReason works for watch processor\n */\n\nconst namespace1 = \"hello-pepr-deletion-timestamp1\";\nconst namespace2 = \"hello-pepr-deletion-timestamp2\";\n\nexport const HelloPeprDeletion = new Capability({\n  name: \"hello-pepr-deletion-timestamp\",\n  description: \"e2e deletion timestamp filter.\",\n  namespaces: [namespace1, namespace2],\n});\n\nconst { When } = HelloPeprDeletion;\n\n/*\n * Module Helpers\n */\nconst addFinalizer = async (name: string) => {\n  const patchOperations: Operation[] = [\n    {\n      op: \"add\",\n      path: \"/metadata/finalizers\",\n      value: [\"example.com/my-finalizer\"],\n    },\n  ];\n  try {\n    await K8s(a.Pod, { name, namespace: namespace1 }).Patch(patchOperations);\n  } catch (e) {\n    Log.error(`DTS: Error adding finalizer to pod ${name}: ${JSON.stringify(e)}`);\n  }\n};\n\nconst removeFinalizer = async (name: string) => {\n  const patchOperations: Operation[] = [\n    { op: \"remove\", path: \"/metadata/finalizers\" },\n  ];\n  try {\n    await K8s(a.Pod, { name, namespace: namespace1 }).Patch(patchOperations);\n  } catch (e) {\n    Log.error(`DTS: Error removing finalizer from pod ${name}: ${JSON.stringify(e)}`);\n  }\n};\n\nconst updateObj = async (obj: GenericKind) => {\n\n  const patchOperations: Operation[] = [\n    {\n      op: \"add\",\n      path: \"/metadata/labels/app\",\n      value: \"testing\",\n    },\n  ];\n  try {\n    await K8s(a.Pod, { name: obj.metadata.name, namespace: namespace2 }).Patch(patchOperations);\n  } catch (e) {\n    Log.error(`DTS: Error updating pod ${obj.metadata.name}: ${JSON.stringify(e)}`);\n  }\n};\nconst deleteObj = async (obj: GenericKind) => {\n  try {\n    await K8s(a.Pod).InNamespace(namespace1).Delete(obj.metadata.name);\n  } catch (e) {\n    Log.error(`DTS: Error deleting pod ${obj.metadata.name}: ${JSON.stringify(e)}`);\n  }\n};\n\nconst logSeen = (name: string) => {\n  Log.info(`DTS: Saw a pod ${name}.`);\n};\n\n/*\n * Namespace 1 - Tests\n * Description: Trigger deletion timestamps by creating a finalizer and deleting the pod.\n */\nWhen(a.Pod)\n  .IsCreated()\n  .InNamespace(namespace1)\n  .WithName(\"ns1-admission\")\n  .Watch(async po => {\n    await addFinalizer(po.metadata.name);\n    await deleteObj(po);\n    await removeFinalizer(po.metadata.name);\n  });\n\nWhen(a.Pod)\n  .IsCreated()\n  .InNamespace(namespace1)\n  .WithName(\"ns1-watch\")\n  .Watch(async po => {\n    await addFinalizer(po.metadata.name);\n    await deleteObj(po);\n    await removeFinalizer(po.metadata.name);\n  });\n\n/*\n * Description: Test WithDeletionTimestamp Filter for an Admission Processor\n */\nWhen(a.Pod)\n  .IsUpdated()\n  .InNamespace(namespace1)\n  .WithName(\"ns1-admission\")\n  .WithDeletionTimestamp()\n  .Mutate(po => {\n    logSeen(po.Raw.metadata.name);\n  });\n\n/*\n * Description: Test WithDeletionTimestamp Filter for a Watch/Reconcile Processor\n */\nWhen(a.Pod)\n  .IsUpdated()\n  .InNamespace(namespace1)\n  .WithName(\"ns1-watch\")\n  .WithDeletionTimestamp()\n  .Watch(po => logSeen(po.metadata.name));\n\n/*\n * Namespace 2 - Tests\n * Description: Trigger an update and without trigger withDeletionTimestamp.\n */\nWhen(a.Pod)\n  .IsCreated()\n  .InNamespace(namespace2)\n  .WithName(\"ns2-admission\")\n  .Watch(async(po) => await updateObj(po));\n\nWhen(a.Pod)\n  .IsCreated()\n  .InNamespace(namespace2)\n  .WithName(\"ns2-watch\")\n  .Watch(async(po) => await updateObj(po));\n\n/*\n * Description WithDeletionTimestamp Filter should not be called - Admission Processor\n */\nWhen(a.Pod)\n  .IsUpdated()\n  .InNamespace(namespace2)\n  .WithName(\"ns2-admission\")\n  .WithDeletionTimestamp()\n  .Mutate(po => logSeen(po.Raw.metadata.name));\n\n/*\n * Description: WithDeletionTimestamp Filter should not be called - Watch/Reconcile Processor\n */\nWhen(a.Pod)\n  .IsUpdated()\n  .InNamespace(namespace2)\n  .WithName(\"ns2-watch\")\n  .WithDeletionTimestamp()\n  .Watch(po => logSeen(po.metadata.name));\n\n/*\n * Description: WithDeletionTimestamp Filter should  be called - Watch/Reconcile Processor\n */\nWhen(a.Pod)\n  .IsDeleted()\n  .InNamespace(namespace2)\n  .WithName(\"ns2-delete\")\n  .WithDeletionTimestamp()\n  .Watch(po => logSeen(po.metadata.name));\n"],
  "mappings": "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",
  "names": ["import_pepr", "package_default", "import_pepr", "namespace1", "namespace2", "HelloPeprDeletion", "When", "addFinalizer", "__name", "name", "patchOperations", "e", "removeFinalizer", "updateObj", "obj", "deleteObj", "logSeen", "po", "package_default", "HelloPeprDeletion"]
}
