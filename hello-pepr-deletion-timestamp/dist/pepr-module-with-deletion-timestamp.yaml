apiVersion: v1
kind: Namespace
metadata:
  name: pepr-system
  labels:
    pepr.dev: ''
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pepr-with-deletion-timestamp
rules:
  - apiGroups:
      - '*'
    resources:
      - '*'
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pepr-with-deletion-timestamp
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pepr-with-deletion-timestamp
subjects:
  - kind: ServiceAccount
    name: pepr-with-deletion-timestamp
    namespace: pepr-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pepr-with-deletion-timestamp
  namespace: pepr-system
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-with-deletion-timestamp-api-token
  namespace: pepr-system
type: Opaque
data:
  value: >-
    Mjg1YWY1NTQyNDJlYTZjM2UwZDZkOGExZDNjOGE3MjdjNmM4ZWRkNTgyMDY4NmJlMGU2NzY2YmM1ZTA4OGY1Mg==
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-with-deletion-timestamp-tls
  namespace: pepr-system
type: kubernetes.io/tls
data:
  tls.crt: >-
    LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tDQpNSUlDdGpDQ0FaNmdBd0lCQWdJQkFUQU5CZ2txaGtpRzl3MEJBUXNGQURBQU1CNFhEVEkwTURnek1ERTNNVEV4DQpOVm9YRFRJMU1EZ3pNREUzTVRFeE5Wb3dBRENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DDQpnZ0VCQUtTUkNqV3JqSjZaVTFDL1R2cHR0Q2NjQ3dlVXQ2SzVLVXFmdmhOWi9Gb2hjS05QTUxzVEZBcUlVZ3VSDQpRT2Vwa3czRFB3UzdnUGtIaURJTW5KRzY4SkpSZEMvdFlsOVl5WHppSHRZYWIwd2JubGlXNVp5ZFp0SENQNENQDQppL3NqeHhPMzIzbFB3L3dDRTdLSkVLYjNYM01UdEJ2TWJ6NUE4OG1EVFdJZGxTMURWbFRKcWhKbmZFaUdkeFRQDQprQVZRUG5Fd2FteTBYTkVwWVJydlFYY1VLQlBtKzFNZU1uejQwcEMzQTlYS0pMaHhwRCtaR2QrS0JSR250ajB4DQphZmkyeEQ1VHl5ekFtc0VkV1p5WllTZVJqOTI4WGdNWWc4YkR2WDh6V0ZvOWZFYVIyelhvQTJWWTNwYmtLRTBWDQoydUhjeVZjMWNRWmZCM3Y3ZlRjb3FKeGEyeU1DQXdFQUFhTTdNRGt3TndZRFZSMFJCREF3TG9Jc2NHVndjaTEzDQphWFJvTFdSbGJHVjBhVzl1TFhScGJXVnpkR0Z0Y0M1d1pYQnlMWE41YzNSbGJTNXpkbU13RFFZSktvWklodmNODQpBUUVMQlFBRGdnRUJBSG5BaWZCTDYyYzFJaHdkK09pN0lXb25QK1JVdXBxamE4bTg2YzJWZjQyZFYwd2NvS2FKDQphYzN0SU55c0paYS91UEZhenl0TGtEZmdZMGE1dGZFbXJxbGNYWEk3bXlTUjdvaWNoMURKbTJscVNoVTZ0NnFYDQp0WG14djZXNUMzTUFodGlzdjloTnlKdW5YZ0xGaWJ2UFcwRFdXRTFiSjBWU1VPcFAyMHg5RTBnYi9VVHJuTnFkDQpTL3dkTk5DTTl3UmdEaitocWU4SzR5akNsSUNnaEE3RkQ0bjcrSzlGbkJHNFlUK2JCZEdLN2sxTThSWm0rQnhsDQp5SW5yOElFbWt4bTNsWmdmOStBSHhQZXE2SWpEc1BCTGFka2lVYW5sc2ZjK2FXMlRRSGMvdXViS3hPSGVzMDRyDQoyTzdVVTVZS0pSNWpINmZyZ1NNQy8vanR3RzljWWIzSXJjVT0NCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0NCg==
  tls.key: >-
    LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQ0KTUlJRW93SUJBQUtDQVFFQXBKRUtOYXVNbnBsVFVMOU8rbTIwSnh3TEI1UzNvcmtwU3ArK0UxbjhXaUZ3bzA4dw0KdXhNVUNvaFNDNUZBNTZtVERjTS9CTHVBK1FlSU1neWNrYnJ3a2xGMEwrMWlYMWpKZk9JZTFocHZUQnVlV0pibA0KbkoxbTBjSS9nSStMK3lQSEU3ZmJlVS9EL0FJVHNva1FwdmRmY3hPMEc4eHZQa0R6eVlOTlloMlZMVU5XVk1tcQ0KRW1kOFNJWjNGTStRQlZBK2NUQnFiTFJjMFNsaEd1OUJkeFFvRStiN1V4NHlmUGpTa0xjRDFjb2t1SEdrUDVrWg0KMzRvRkVhZTJQVEZwK0xiRVBsUExMTUNhd1IxWm5KbGhKNUdQM2J4ZUF4aUR4c085ZnpOWVdqMThScEhiTmVnRA0KWlZqZWx1UW9UUlhhNGR6SlZ6VnhCbDhIZS90OU55aW9uRnJiSXdJREFRQUJBb0lCQUEwVnE5ZWs3N1haTldWKw0Kc3ppNGlmSHdIMSszYnpzYUkzMHMrQVVtNEZNMFJIWDFBUjFtd01SWTlCa1BzQXhHRUl5d0ZsaDUwTXZtMFpQcQ0KZjhwd2hZU2FHR0JmMTE5WVpSRGFhUjdzbENhR0xhVnRQZzEycGNCamhGUVBBSG9lbC9ZVk8zZEkrZFFWbFlaYQ0KWFQ5ci9NNjBFREV1VHpheEhidkxNUUhEbmcydW83QmlzbzdSQ2ZQNEVxemdUZ0d5N0NmOXlGd1FHWW8wUVozRw0KOVJCWVFQdXR4ZkRXK0ZTYzhzTXJGTDBZRzkrTEw0cUgwdlJHN2RFazgwb01ENzllNndtc3J0WFJnY2FMQVdVYw0KVVFNUUJKY0FmaHpZcmxNYzlFMklxSWVVZjVXamxxcDBtd0pPbCtXRmFjZlRWL3VMek9TMTZwOHk0MWpZTy8zbQ0KZkEwUm5MRUNnWUVBNEJua3dJUXJoWG1TRGxhTkZwMjZYYzhVL1J2YU9BdFZEL0hidlhUMmtMSDJtT3EyTDJrQQ0KalVhdUJpUEpCb3hKZldueWlNSHBWc1lpbGN6eCszLzVSUm5RZWlpOXM3MHVaQVRlaGhBVmpWTW8yN0tWZzJyUQ0KK05pR2RVc2ZNcC9iNys5STRRb3FYWS9WU084NWJhNEF1djFkNDlDUFEyUWxrSUFRRkkrcHhKRUNnWUVBdS8yKw0KT2ZwbTdoWjF1WFNiNU1wK0hWZ0VMQW81VE9NMzJoSlBUZmZ5WC81Y0J1N3d6MWQ1bFREYk4xQjV2d0RVcy9JQg0KSHBXUVpmbHdHRVpzR1c4RllsdGxHaDFXSzZNYW1MdjU3a0g4dWlJYjE4d3o0VDhXaWF4SlBDcVNVQkJjYUpGSw0KcXZaSWdld3h0dDFxdUZkNjdJaWZJSzRMY2xMa1pxbG1CZ0l0cm5NQ2dZRUFsVkZMZE9iYjVNUjdCK2l0ZTFzKw0KK1JCb3lMa05MbmlHaGVnOTVMK1JKaG9kMkFmVHVrVTVZK2lyUFZZTXRMczJvRVMrb0ZhcjlmQnd6T1ZRZXFYcg0KWGhwMEtXRUovVC9aTURWNlcxTk9PT3NtOXpQSG9WZkR3M3JxSkM4WXEyK09hUkZEdXdZOThqZExBcHk2NUJTag0KVWZSTjRlUnVBSll5M1ZRbTRyeFNmckVDZ1lBallUZmgxWHgxcG9oMVpMcktMa25aMyt5NUZSdC9tdXV5QU93bg0KOGxnTk5PUEE4a3NqMm9TcFRVNlVkSExWUGFUS1VPdGhCQ2p1NkNqdWlLSmpqdjltYVdqM3B6bkdjS1hheE5YZQ0KdjFCKy8xaGFIclpNMkFDMzNGTFVIZmIzVm56dHVScGlYb042NENiakVYeTZRTXlEbzVxL0hjSk51OGY4Z2prUA0KUEcyNGZRS0JnRXd5NUlPRDRsT3pZbHNIOTZTQUpuZDhNRGpCY2F4c2YwSW1JOUNobDlybFVTS0xGdnZ1VVpGbA0KOHc3VTFhdDFvZ0pZZVhIZWFrSGExcDdEQ2ZiNVljZ2ZvcFdnbHVMbFFIWUZpVzBmRkxQVE1XMEM3ZE41RVNkaw0Kb3JNeFBCeUh1SUt2T1BTQTBOT1ZRNDlxTUsrOEU5Mnh4UTdET2F1Z3lVRi95dDJKaDVZeA0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0NCg==
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pepr-with-deletion-timestamp
  namespace: pepr-system
  annotations:
    pepr.dev/description: 'Pepr feature: WithDeletionTimestamp'
  labels:
    app: pepr-with-deletion-timestamp
    pepr.dev/controller: admission
    pepr.dev/uuid: with-deletion-timestamp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: pepr-with-deletion-timestamp
      pepr.dev/controller: admission
  template:
    metadata:
      annotations:
        buildTimestamp: '1725037874989'
      labels:
        app: pepr-with-deletion-timestamp
        pepr.dev/controller: admission
    spec:
      terminationGracePeriodSeconds: 5
      priorityClassName: system-node-critical
      serviceAccountName: pepr-with-deletion-timestamp
      securityContext:
        runAsUser: 65532
        runAsGroup: 65532
        runAsNonRoot: true
        fsGroup: 65532
      containers:
        - name: server
          image: ghcr.io/defenseunicorns/pepr/controller:v0.0.0-development
          imagePullPolicy: IfNotPresent
          command:
            - node
            - /app/node_modules/pepr/dist/controller.js
            - 7f693d1154bb0c53d240bb491ac0b6c521b8b820c02b39da860100155623ff76
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
            initialDelaySeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
            initialDelaySeconds: 10
          ports:
            - containerPort: 3000
          resources:
            requests:
              memory: 64Mi
              cpu: 100m
            limits:
              memory: 256Mi
              cpu: 500m
          env:
            - name: PEPR_WATCH_MODE
              value: 'false'
            - name: PEPR_PRETTY_LOG
              value: 'false'
            - name: LOG_LEVEL
              value: info
          securityContext:
            runAsUser: 65532
            runAsGroup: 65532
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tls-certs
              mountPath: /etc/certs
              readOnly: true
            - name: api-token
              mountPath: /app/api-token
              readOnly: true
            - name: module
              mountPath: /app/load
              readOnly: true
      volumes:
        - name: tls-certs
          secret:
            secretName: pepr-with-deletion-timestamp-tls
        - name: api-token
          secret:
            secretName: pepr-with-deletion-timestamp-api-token
        - name: module
          secret:
            secretName: pepr-with-deletion-timestamp-module
---
apiVersion: v1
kind: Service
metadata:
  name: pepr-with-deletion-timestamp
  namespace: pepr-system
  labels:
    pepr.dev/controller: admission
spec:
  selector:
    app: pepr-with-deletion-timestamp
    pepr.dev/controller: admission
  ports:
    - port: 443
      targetPort: 3000
---
apiVersion: v1
kind: Service
metadata:
  name: pepr-with-deletion-timestamp-watcher
  namespace: pepr-system
  labels:
    pepr.dev/controller: watcher
spec:
  selector:
    app: pepr-with-deletion-timestamp-watcher
    pepr.dev/controller: watcher
  ports:
    - port: 443
      targetPort: 3000
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-with-deletion-timestamp-module
  namespace: pepr-system
type: Opaque
data:
  module-7f693d1154bb0c53d240bb491ac0b6c521b8b820c02b39da860100155623ff76.js.gz: >-
    H4sIAAAAAAAAE7VWXW/bNhR976/guDxIAEXbyT46BQoKNCvQLWmCpkUfghSlxWubCUWyJGVNE/TfB1K2myxxvtC+ieS5vOece0lxySxqi5PpJZSecpgJBadWG7C+3V8yi6oiAeLT4qBNgGDFKsCkWzJZQ+5JqdVMzGvLphLyn8Z9GkOawsLXWlhIsAFj8TDLiy5E53gBUuosrGQcJHihVeZFBc6zymCyBOuEVjke0zGdYMLBlVYYH+dOwVg0A+ZrCzn6JPzicLXFh287XEHbaMtdfj7kJ/jqpcMEGy1F2Wag5kJBGAcKlea1DCMHZW2Fb/EFGRAu75TmkOODYvKSjukY9ySE5F1dC57jRvjFnQq0+tNabXNsIbiKSQPThdZXgaKufT4Zk7J2XldHbAoypGEVOMNKyLtIinJY4hzjvidMNqx1b+dKW7gGdPn5RU+EKmXNgb8RcjXDwYDioEoR6Ee2+POY7v1CJzisLg9vAPCrS3B+NJd6yqTDOf68+wf9nY4xwa98a8CNggNxfkwne2EhBFzHXdVTsAo8uGwma1A+K6UA5WMQ/S1UMO4Ua5jjX+ke3cM9GcYbjkOdSilyrEyFbK1QljXaXkW1aAHSgHWolAJlGcpWVSt2EtPwFBMfSa0jV6gwibLM1cIDYlJigiMOdoOi+8ABsQLXSvgH0BHS97HJ2Z2tL4r7m36CiXsAsouJKRQ0iNHXzLCpkMK3yeNO1I0TBLuA1iC0AaGZkB4sxeR6iwniLvqUdJ8WoHLVF4aURZUw16oSQXHQSfDIF+edNjlmnGNimF/keFSBZ5x5NpoJxaT4F6zDZLgzzjH8wyojgZa6GlVttoHgi/5i39u2Yw0TPhkTRv9+6dKEUUZPNSeDVvhGMBd9Sk+ZLxeJT/syfti0Y/RIzymEE5h8OfxwlqN4GhHjXKg52uRDXiOjOdrpoM/RTvfX2ck76rwVai5mbWLT/kva9yQIe7PhmBK51QELlV7CvSb8WIWRwE2NM6urR6kcyF8XunhaqWW8y0bMmHWp4wESav441XS9Ew3jax64J3lQG85C0rXom9vea0EMhZPpJU5JfUP8dvYpfaverakmIqXxdwTJ//KuifvtxIcz+RTifk08hq6I66JKAuUhjVAzvcpyxhrENq1Av6Q9wVLPzwAUTvfVNUHutQXmgSe3xIX/bZhIsHKTjPFKuPCrxin9FOV9cyy6hcpbPpBhoU42n/K2V8+j0wQKP5jKx9giT3PmrjdKktLj2rPQKMVBpxOg71nzfXJvbNiSd7AHigN9S+2jfHc3E+7e1waDrYvkuVtvKenWbe+26H7GD5bn7uo8L/P3K85wzzyYcLganp0RGtTQ8OY+ju+thJNzc5HuvxiNfkZO17aEY2aMUPOP74+K+P7Y8iiml45WzLz4DwxLGwhuDAAA
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pepr-with-deletion-timestamp-store
  namespace: pepr-system
rules:
  - apiGroups:
      - pepr.dev
    resources:
      - peprstores
    resourceNames:
      - ''
    verbs:
      - create
      - get
      - patch
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pepr-with-deletion-timestamp-store
  namespace: pepr-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pepr-with-deletion-timestamp-store
subjects:
  - kind: ServiceAccount
    name: pepr-with-deletion-timestamp-store
    namespace: pepr-system
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: pepr-with-deletion-timestamp
webhooks:
  - name: pepr-with-deletion-timestamp.pepr.dev
    admissionReviewVersions:
      - v1
      - v1beta1
    clientConfig:
      caBundle: >-
        LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tDQpNSUlDdERDQ0FaeWdBd0lCQWdJQkFUQU5CZ2txaGtpRzl3MEJBUXNGQURBY01Sb3dHQVlEVlFRREV4RlFaWEJ5DQpJRVZ3YUdWdFpYSmhiQ0JEUVRBZUZ3MHlOREE0TXpBeE56RXhNVFZhRncweU5UQTRNekF4TnpFeE1UVmFNQUF3DQpnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDNTFXVTZpM0M0ckF0RVoyRERsdEs1DQpHWkErbU1tOGYxb2hQa1dJRGRvVFdoNmg4RWJVRDErck1ZcnlaSUpINDU3MGVJSmdEYUlybkFtaXhibDl6eC9XDQowNkR1TWVjZ0JKblhqT0RpRUlMQnU1aTZmMUFmWDFYU1RhNzlMK2RTL0Y5bHdwejBqU0I0RmMwQTQ4cU15eEZiDQp4MzlhUFlvMmZjSHR6LzlneUwvTzFIM21oTTZUdUsrcWFNQTY0NElQM0xvcmthVGRjQ3NUYStVZThwZ0IxMkV0DQpFOEI5RzVtdFFLRFkybmR0UldteVBKeUJlMDhJd25kRDVEYVVoQjhNRytjZ1pvWk4yTWtrMXVwNkNBUW1UNGJlDQpSN0FJWVJhOWZlMUwxUWtSWWtmaTdsUEdqTVA1SlpFZDVnOStvUWduL3hVTmc0S0U5anFVeFJuelUvOXZJaUVYDQpBZ01CQUFHakhUQWJNQXdHQTFVZEV3UUZNQU1CQWY4d0N3WURWUjBQQkFRREFnTDBNQTBHQ1NxR1NJYjNEUUVCDQpDd1VBQTRJQkFRQVdDTVA2WDZockR2VW1LUXZUTitCcE94NzE4QVFyQVhKTlNHN1BYWlZnaTlZM2ZKbnRDTkl0DQpQaEZzRlBDL0crQ1NVVG5DNW9QYTNBeEhVMEV2RU02L1ZpdGU4WUdMRVR6Y1RRaFBIQVgwRm1XZ2krU1ZNY0xCDQo0bytKYnhHY25DK0RaQjg5TDJycUxGdzZoWW1FK2E2K3pkZzFDVWNtL3NPeVdabkZYek1SdXlTMGQ0MDc5dWwxDQphSTVRV3ZNSDBSeVVtNmNKWWlnd0Z5QUIxZ09FRWZpWmNHVkxMOXBvdGM3UEJobkk5SnNkZG5Cbk44N0VTNzdyDQpzNUtIMEV3ZFk3WjMvMDV5VFlKQlg5SUprV2VDT292UnVPMmRiUzM3YkRtNzFtbmIwa0JiQXZVdkE2a1k3R1JRDQprSFJqN2hMbFBKNmphWVBOSFl1bys2MVJuWUY5TDQ0aw0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ0K
      service:
        name: pepr-with-deletion-timestamp
        namespace: pepr-system
        path: >-
          /mutate/285af554242ea6c3e0d6d8a1d3c8a727c6c8edd5820686be0e6766bc5e088f52
    failurePolicy: Fail
    matchPolicy: Equivalent
    timeoutSeconds: 10
    namespaceSelector:
      matchExpressions:
        - key: pepr.dev
          operator: NotIn
          values:
            - ignore
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values:
            - kube-system
            - pepr-system
    objectSelector:
      matchExpressions:
        - key: pepr.dev
          operator: NotIn
          values:
            - ignore
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values:
            - kube-system
            - pepr-system
    rules:
      - apiGroups:
          - ''
        apiVersions:
          - v1
        operations:
          - UPDATE
        resources:
          - pods
          - pods/ephemeralcontainers
    sideEffects: None
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pepr-with-deletion-timestamp-watcher
  namespace: pepr-system
  annotations:
    pepr.dev/description: 'Pepr feature: WithDeletionTimestamp'
  labels:
    app: pepr-with-deletion-timestamp-watcher
    pepr.dev/controller: watcher
    pepr.dev/uuid: with-deletion-timestamp
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: pepr-with-deletion-timestamp-watcher
      pepr.dev/controller: watcher
  template:
    metadata:
      annotations:
        buildTimestamp: '1725037874989'
      labels:
        app: pepr-with-deletion-timestamp-watcher
        pepr.dev/controller: watcher
    spec:
      terminationGracePeriodSeconds: 5
      serviceAccountName: pepr-with-deletion-timestamp
      securityContext:
        runAsUser: 65532
        runAsGroup: 65532
        runAsNonRoot: true
        fsGroup: 65532
      containers:
        - name: watcher
          image: ghcr.io/defenseunicorns/pepr/controller:v0.0.0-development
          imagePullPolicy: IfNotPresent
          command:
            - node
            - /app/node_modules/pepr/dist/controller.js
            - 7f693d1154bb0c53d240bb491ac0b6c521b8b820c02b39da860100155623ff76
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
            initialDelaySeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
            initialDelaySeconds: 10
          ports:
            - containerPort: 3000
          resources:
            requests:
              memory: 64Mi
              cpu: 100m
            limits:
              memory: 256Mi
              cpu: 500m
          securityContext:
            runAsUser: 65532
            runAsGroup: 65532
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tls-certs
              mountPath: /etc/certs
              readOnly: true
            - name: module
              mountPath: /app/load
              readOnly: true
          env:
            - name: PEPR_WATCH_MODE
              value: 'true'
            - name: PEPR_PRETTY_LOG
              value: 'false'
            - name: LOG_LEVEL
              value: info
      volumes:
        - name: tls-certs
          secret:
            secretName: pepr-with-deletion-timestamp-tls
        - name: module
          secret:
            secretName: pepr-with-deletion-timestamp-module
