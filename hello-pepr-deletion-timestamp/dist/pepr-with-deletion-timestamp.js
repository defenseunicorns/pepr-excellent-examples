var y=Object.defineProperty;var m=(e,t)=>y(e,"name",{value:t,configurable:!0});var w=require("pepr");var d={name:"hello-pepr-deletion-timestamp",version:"0.0.1",description:"Pepr feature: WithDeletionTimestamp",keywords:["pepr","k8s","policy-engine","pepr-module","security"],engines:{node:">=18.0.0"},pepr:{uuid:"with-deletion-timestamp",onError:"reject",webhookTimeout:10,customLabels:{namespace:{"pepr.dev":""}},alwaysIgnore:{namespaces:[]},includedFiles:[]},dependencies:{pepr:"^0.34.1"},devDependencies:{"@jest/globals":"^29.7.0","@types/node":"^20.13.0",jest:"^29.7.0","kubernetes-fluent-client":"^2.6.1",typescript:"5.3.3"},scripts:{pepr:"pepr",cli:"npm run --workspace helpers cli -- --module=$(pwd)",test:"npm run cli -- test --suite all","test:e2e":"npm run cli -- test --suite e2e","test:unit":"npm run cli -- test --suite unit"}};var a=require("pepr");var i="hello-pepr-deletion-timestamp1",s="hello-pepr-deletion-timestamp2",p=new a.Capability({name:"hello-pepr-deletion-timestamp",description:"e2e deletion timestamp filter.",namespaces:[i,s]}),{When:n}=p,c=m(async e=>{let t=[{op:"add",path:"/metadata/finalizers",value:["example.com/my-finalizer"]}];try{await(0,a.K8s)(a.a.Pod,{name:e,namespace:i}).Patch(t)}catch(r){a.Log.error(`DTS: Error adding finalizer to pod ${e}: ${JSON.stringify(r)}`)}},"addFinalizer"),l=m(async e=>{let t=[{op:"remove",path:"/metadata/finalizers"}];try{await(0,a.K8s)(a.a.Pod,{name:e,namespace:i}).Patch(t)}catch(r){a.Log.error(`DTS: Error removing finalizer from pod ${e}: ${JSON.stringify(r)}`)}},"removeFinalizer"),h=m(async e=>{let t=[{op:"add",path:"/metadata/labels/app",value:"testing"}];try{await(0,a.K8s)(a.a.Pod,{name:e.metadata.name,namespace:s}).Patch(t)}catch(r){a.Log.error(`DTS: Error updating pod ${e.metadata.name}: ${JSON.stringify(r)}`)}},"updateObj"),u=m(async e=>{try{await(0,a.K8s)(a.a.Pod).InNamespace(i).Delete(e.metadata.name)}catch(t){a.Log.error(`DTS: Error deleting pod ${e.metadata.name}: ${JSON.stringify(t)}`)}},"deleteObj"),o=m(e=>{a.Log.info(`DTS: Saw a pod ${e}.`)},"logSeen");n(a.a.Pod).IsCreated().InNamespace(i).WithName("ns1-admission").Watch(async e=>{await c(e.metadata.name),await u(e),await l(e.metadata.name)});n(a.a.Pod).IsCreated().InNamespace(i).WithName("ns1-watch").Watch(async e=>{await c(e.metadata.name),await u(e),await l(e.metadata.name)});n(a.a.Pod).IsUpdated().InNamespace(i).WithName("ns1-admission").WithDeletionTimestamp().Mutate(e=>{o(e.Raw.metadata.name)});n(a.a.Pod).IsUpdated().InNamespace(i).WithName("ns1-watch").WithDeletionTimestamp().Watch(e=>o(e.metadata.name));n(a.a.Pod).IsCreated().InNamespace(s).WithName("ns2-admission").Watch(async e=>await h(e));n(a.a.Pod).IsCreated().InNamespace(s).WithName("ns2-watch").Watch(async e=>await h(e));n(a.a.Pod).IsUpdated().InNamespace(s).WithName("ns2-admission").WithDeletionTimestamp().Mutate(e=>o(e.Raw.metadata.name));n(a.a.Pod).IsUpdated().InNamespace(s).WithName("ns2-watch").WithDeletionTimestamp().Watch(e=>o(e.metadata.name));n(a.a.Pod).IsDeleted().InNamespace(s).WithName("ns2-delete").WithDeletionTimestamp().Watch(e=>o(e.metadata.name));new w.PeprModule(d,[p]);
//# sourceMappingURL=pepr-with-deletion-timestamp.js.map
